
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>AI 預診小幫手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f5f5f7;
      height: 100vh;
      display: flex;
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .chat-pane {
      flex: 3;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      background: #fff;
    }
    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f7f7fb;
    }
    .msg { margin-bottom: 10px; max-width: 80%; }
    .msg.ai { text-align: left; }
    .msg.user { text-align: right; margin-left: auto; }
    .bubble {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
    }
    .msg.ai .bubble { background: #fff; border: 1px solid #e1e1e8; }
    .msg.user .bubble { background: #0f8fee; color: #fff; }

    .chat-input {
      display: flex;
      padding: 8px;
      border-top: 1px solid #eee;
      gap: 8px;
    }
    .chat-input input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    .chat-input button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #0f8fee;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .video-pane {
      flex: 2;
      display: flex;
      flex-direction: column;
      padding: 16px;
      background: radial-gradient(circle at top, #e4f1ff, #f5f5f7);
    }
    .video-card {
      flex: 1;
      border-radius: 16px;
      background: #000;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow .3s ease;
    }
    .video-card video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4ade80;
      margin-right: 4px;
    }
    .video-card.talking {
      box-shadow: 0 0 0 2px #0f8fee, 0 16px 32px rgba(15,143,238,0.4);
    }
    .video-footer {
      margin-top: 8px;
      font-size: 12px;
      color: #555;
    }
    .warn {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .video-pane { order: -1; height: 40vh; }
      .chat-pane { flex: 1; }
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- 聊天區 -->
    <section class="chat-pane">
      <div class="chat-header">AI 預診小幫手</div>
      <div id="messages" class="chat-messages"></div>

      <form id="chat-form" class="chat-input">
        <input id="input" autocomplete="off" placeholder="輸入想跟 AI 醫療助手說的話…" />
        <button id="send-btn" type="submit">送出</button>
      </form>
    </section>

    <!-- 假視訊區 -->
    <section class="video-pane">
      <div id="videoCard" class="video-card">
        <video id="docVideo" src="/public/doctor-loop.mp4"
               autoplay muted loop playsinline></video>
        <div class="badge"><span class="status-dot"></span>AI 虛擬醫師（非真人）</div>
      </div>

      <div class="video-footer">
        這是 AI 預診助手模擬畫面，最終醫療判斷由真正醫師提供。
        <div class="warn">
          若出現胸痛、呼吸困難、意識改變等急重症狀，請立即尋求急救協助。
        </div>
      </div>
    </section>
  </div>

<script>
  const $msg = document.getElementById("messages");
  const $form = document.getElementById("chat-form");
  const $input = document.getElementById("input");
  const $btn = document.getElementById("send-btn");
  const $videoCard = document.getElementById("videoCard");

  function getUserId() {
    let id = localStorage.getItem("web-user-id");
    if (!id) {
      id = "web-" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("web-user-id", id);
    }
    return id;
  }
  const userId = getUserId();

  function addMessage(text, role) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    div.appendChild(bubble);
    $msg.appendChild(div);
    $msg.scrollTop = $msg.scrollHeight;
  }

  function markTalking() {
    $videoCard.classList.add("talking");
    setTimeout(() => $videoCard.classList.remove("talking"), 2500);
  }

  // 初次進來：問候語
  addMessage("嗨～我是 AI 預診小幫手。讓我先了解你的狀況，幫你整理重點給醫師喔！今天主要哪裡不舒服呢？", "ai");
  markTalking();

  $form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = $input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    $input.value = "";
    $btn.disabled = true;

    try {
      const resp = await fetch("/api/web-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, message: text })
      });
      if (!resp.ok) throw new Error("API Error: " + resp.status);
      const data = await resp.json();
      const reply = data.reply || "我收到你的訊息了！";

      addMessage(reply, "ai");
      markTalking();
    } catch (err) {
      console.error(err);
      addMessage("我這邊連線有點問題，可以稍後再試一次嗎？", "ai");
      markTalking();
    }

    $btn.disabled = false;
  });
</script>

</body>
</html>
