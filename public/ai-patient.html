
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>AI é è¨ºå°å¹«æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f5f5f7;
      height: 100vh;
      display: flex;
    }
    .layout {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .chat-pane {
      flex: 3;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      background: #fff;
    }
    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f7f7fb;
    }
    .msg { margin-bottom: 10px; max-width: 80%; }
    .msg.ai { text-align: left; }
    .msg.user { text-align: right; margin-left: auto; }
    .bubble {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
    }
    .msg.ai .bubble { background: #fff; border: 1px solid #e1e1e8; }
    .msg.user .bubble { background: #0f8fee; color: #fff; }
    .chat-input {
      display: flex;
      padding: 8px;
      border-top: 1px solid #eee;
      gap: 8px;
    }
    .chat-input input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    .chat-input button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      background: #0f8fee;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    .chat-input button:disabled {
      opacity: .6;
      cursor: default;
    }
    .video-pane {
      flex: 2;
      display: flex;
      flex-direction: column;
      padding: 16px;
      background: radial-gradient(circle at top, #e4f1ff, #f5f5f7);
    }
    .video-card {
      flex: 1;
      border-radius: 16px;
      background: #000;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow .3s ease;
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    .video-card video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
    }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4ade80;
      margin-right: 4px;
    }
    .video-card.talking {
      box-shadow: 0 0 0 2px #0f8fee, 0 16px 32px rgba(15,143,238,0.4);
    }
    .video-footer {
      margin-top: 8px;
      font-size: 12px;
      color: #555;
    }
    .warn {
      color: #b91c1c;
      font-size: 12px;
      margin-top: 4px;
    }
    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .video-pane {
        order: -1;
        height: 40vh;
      }
      .chat-pane {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="chat-pane">
      <div class="chat-header">AI é è¨ºå°å¹«æ‰‹</div>
      <div id="messages" class="chat-messages"></div>
      <form id="chat-form" class="chat-input">
        <input id="input" autocomplete="off" placeholder="è¼¸å…¥æˆ–èªªå‡ºæƒ³è·Ÿ AI é†«ç™‚åŠ©æ‰‹èªªçš„è©±â€¦" />
        <button type="button" id="mic-btn" title="èªéŸ³è¼¸å…¥">ğŸ™ï¸</button>
        <button id="send-btn" type="submit">é€å‡º</button>
      </form>
    </section>

    <section class="video-pane">
      <div id="videoCard" class="video-card">
        <video id="docVideo" src="/public/doctor-loop.mp4"
               autoplay muted loop playsinline></video>
        <div class="badge"><span class="status-dot"></span>AI è™›æ“¬é†«å¸«ï¼ˆéçœŸäººï¼‰</div>
      </div>
      <div class="video-footer">
        é€™æ˜¯ AI é è¨ºåŠ©æ‰‹æ¨¡æ“¬ç•«é¢ï¼Œæœ€çµ‚é†«ç™‚åˆ¤æ–·ç”±çœŸæ­£é†«å¸«æä¾›ã€‚
        <div class="warn">
          è‹¥å‡ºç¾èƒ¸ç—›ã€å‘¼å¸å›°é›£ã€æ„è­˜æ”¹è®Šç­‰æ€¥é‡ç—‡ç‹€ï¼Œè«‹ç«‹å³å°‹æ±‚æ€¥æ•‘å”åŠ©ã€‚
        </div>
        <label style="margin-top:6px;display:inline-flex;align-items:center;font-size:12px;gap:4px;">
          <input type="checkbox" id="voice-toggle" checked />
          é–‹å•ŸèªéŸ³å›è¦†ï¼ˆå»ºè­°æ¥ä¸Šè€³æ©Ÿï¼‰
        </label>
      </div>
    </section>
  </div>

<script>
  const $msg = document.getElementById("messages");
  const $form = document.getElementById("chat-form");
  const $input = document.getElementById("input");
  const $btn = document.getElementById("send-btn");
  const $micBtn = document.getElementById("mic-btn");
  const $videoCard = document.getElementById("videoCard");
  const $voiceToggle = document.getElementById("voice-toggle");

  // === èªéŸ³è¼¸å‡ºï¼ˆTTSï¼‰ ===
  let voiceEnabled = false;

  if ($voiceToggle) {
    $voiceToggle.addEventListener("change", () => {
      voiceEnabled = $voiceToggle.checked;
      if (voiceEnabled && "speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    });
  }

  function speak(text) {
    if (!voiceEnabled) return;
    if (!("speechSynthesis" in window)) {
      console.warn("speechSynthesis not supported");
      return;
    }
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "zh-TW";
    utter.rate = 1.0;
    utter.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  }

  // === èªéŸ³è¼¸å…¥ï¼ˆSTTï¼‰ ===
  let recognition = null;
  let recognizing = false;

  (function initSpeech() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      console.warn("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰");
      if ($micBtn) {
        $micBtn.disabled = true;
        $micBtn.title = "ç›®å‰ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥";
      }
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = "zh-TW";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      recognizing = true;
      if ($micBtn) {
        $micBtn.textContent = "ğŸ›‘";
        $micBtn.title = "é»æ“Šåœæ­¢èªéŸ³è¼¸å…¥";
      }
    };

    recognition.onend = () => {
      recognizing = false;
      if ($micBtn) {
        $micBtn.textContent = "ğŸ™ï¸";
        $micBtn.title = "èªéŸ³è¼¸å…¥";
      }
    };

    recognition.onerror = (event) => {
      console.error("speech error", event.error);
      recognizing = false;
      if ($micBtn) {
        $micBtn.textContent = "ğŸ™ï¸";
      }
    };

    recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      if ($input) {
        $input.value = text;
        // è‹¥æƒ³è‡ªå‹•é€å‡ºï¼Œå¯ä»¥æ‰“é–‹é€™è¡Œï¼š
        // $form.requestSubmit();
      }
    };
  })();

  if ($micBtn) {
    $micBtn.addEventListener("click", () => {
      if (!recognition) return;
      if (!recognizing) {
        try {
          recognition.start();
        } catch (e) {
          console.warn("recognition start error", e);
        }
      } else {
        recognition.stop();
      }
    });
  }

  function getUserId() {
    let id = localStorage.getItem("web-user-id");
    if (!id) {
      id = "web-" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("web-user-id", id);
    }
    return id;
  }
  const userId = getUserId();

  function addMessage(text, role) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    div.appendChild(bubble);
    $msg.appendChild(div);
    $msg.scrollTop = $msg.scrollHeight;
  }

  function markTalking() {
    $videoCard.classList.add("talking");
    setTimeout(() => $videoCard.classList.remove("talking"), 2500);
  }

  // é–‹å ´ç™½
  const welcome = "å—¨ï½æˆ‘æ˜¯ AI é è¨ºå°å¹«æ‰‹ã€‚æˆ‘æœƒå…ˆç°¡å–®äº†è§£ä½ çš„ç‹€æ³ï¼Œå¹«ä½ æŠŠé‡é»æ•´ç†çµ¦é†«å¸«ã€‚ä»Šå¤©ä¸»è¦å“ªè£¡ä¸èˆ’æœå‘¢ï¼Ÿ";
  addMessage(welcome, "ai");
  markTalking();
  speak(welcome);

  $form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = $input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    $input.value = "";
    $btn.disabled = true;

    try {
      const resp = await fetch("/api/web-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, message: text })
      });
      if (!resp.ok) throw new Error("API error " + resp.status);
      const data = await resp.json();
      const reply = data.reply || "æˆ‘æ”¶åˆ°ä½ çš„è¨Šæ¯äº†ï¼";
      addMessage(reply, "ai");
      markTalking();
      speak(reply);
    } catch (err) {
      console.error(err);
      const errMsg = "æˆ‘é€™é‚Šé€£ç·šæœ‰é»å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦ä¸€æ¬¡å—ï¼Ÿ";
      addMessage(errMsg, "ai");
      markTalking();
      speak(errMsg);
    }
    $btn.disabled = false;
  });
</script>
</body>
</html>
